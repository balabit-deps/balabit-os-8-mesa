From 80f0726e4c47c15a3d78ff9afde41e0f4160e2fe Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Ol=C5=A1=C3=A1k?= <marek.olsak@amd.com>
Date: Fri, 16 Oct 2020 09:22:44 -0400
Subject: [PATCH] amd: add Beige Goby support

Acked-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/10878>
---
 src/amd/addrlib/src/amdgpu_asic_addr.h      | 2 ++
 src/amd/addrlib/src/gfx10/gfx10addrlib.cpp  | 6 ++++++
 src/amd/common/ac_gpu_info.c                | 2 ++
 src/amd/common/amd_family.c                 | 2 ++
 src/amd/common/amd_family.h                 | 1 +
 src/amd/llvm/ac_llvm_util.c                 | 1 +
 src/gallium/drivers/radeon/radeon_vcn_dec.c | 1 +
 src/gallium/drivers/radeonsi/si_get.c       | 2 +-
 8 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/amd/addrlib/src/amdgpu_asic_addr.h b/src/amd/addrlib/src/amdgpu_asic_addr.h
index cace1dc7898..d125bdad059 100644
--- a/src/amd/addrlib/src/amdgpu_asic_addr.h
+++ b/src/amd/addrlib/src/amdgpu_asic_addr.h
@@ -104,6 +104,7 @@
 #define AMDGPU_SIENNA_CICHLID_RANGE     0x28, 0x32
 #define AMDGPU_NAVY_FLOUNDER_RANGE      0x32, 0x3C
 #define AMDGPU_DIMGREY_CAVEFISH_RANGE   0x3C, 0x46
+#define AMDGPU_BEIGE_GOBY_RANGE         0x46, 0x50
 
 #define AMDGPU_VANGOGH_RANGE    0x01, 0xFF
 
@@ -160,6 +161,7 @@
 #define ASICREV_IS_SIENNA_CICHLID(r)   ASICREV_IS(r, SIENNA_CICHLID)
 #define ASICREV_IS_NAVY_FLOUNDER(r)    ASICREV_IS(r, NAVY_FLOUNDER)
 #define ASICREV_IS_DIMGREY_CAVEFISH(r) ASICREV_IS(r, DIMGREY_CAVEFISH)
+#define ASICREV_IS_BEIGE_GOBY(r)       ASICREV_IS(r, BEIGE_GOBY)
 
 #define ASICREV_IS_VANGOGH(r)          ASICREV_IS(r, VANGOGH)
 
diff --git a/src/amd/addrlib/src/gfx10/gfx10addrlib.cpp b/src/amd/addrlib/src/gfx10/gfx10addrlib.cpp
index 0ae6e094c7c..814dff4378f 100644
--- a/src/amd/addrlib/src/gfx10/gfx10addrlib.cpp
+++ b/src/amd/addrlib/src/gfx10/gfx10addrlib.cpp
@@ -1045,6 +1045,12 @@ ChipFamily Gfx10Lib::HwlConvertChipFamily(
                 m_settings.supportRbPlus   = 1;
                 m_settings.dccUnsup3DSwDis = 0;
             }
+
+            if (ASICREV_IS_BEIGE_GOBY(chipRevision))
+            {
+                m_settings.supportRbPlus   = 1;
+                m_settings.dccUnsup3DSwDis = 0;
+            }
             break;
 
         case FAMILY_VGH:
diff --git a/src/amd/common/ac_gpu_info.c b/src/amd/common/ac_gpu_info.c
index 42801137910..c2e23030962 100644
--- a/src/amd/common/ac_gpu_info.c
+++ b/src/amd/common/ac_gpu_info.c
@@ -620,6 +620,7 @@ bool ac_query_gpu_info(int fd, void *dev_p, struct radeon_info *info,
       identify_chip(SIENNA_CICHLID);
       identify_chip(NAVY_FLOUNDER);
       identify_chip(DIMGREY_CAVEFISH);
+      identify_chip(BEIGE_GOBY);
       break;
    case FAMILY_VGH:
       identify_chip(VANGOGH);
@@ -1012,6 +1013,7 @@ bool ac_query_gpu_info(int fd, void *dev_p, struct radeon_info *info,
          pc_lines = 1024;
          break;
       case CHIP_NAVI14:
+      case CHIP_BEIGE_GOBY:
          pc_lines = 512;
          break;
       case CHIP_VANGOGH:
diff --git a/src/amd/common/amd_family.c b/src/amd/common/amd_family.c
index 8fd802b7c4f..73f2693ff30 100644
--- a/src/amd/common/amd_family.c
+++ b/src/amd/common/amd_family.c
@@ -96,6 +96,8 @@ const char *ac_get_family_name(enum radeon_family family)
       return "dimgrey_cavefish";
    case CHIP_VANGOGH:
       return "vangogh";
+   case CHIP_BEIGE_GOBY:
+      return "beige_goby";
    case CHIP_YELLOW_CARP:
       return "yellow_carp";
    default:
diff --git a/src/amd/common/amd_family.h b/src/amd/common/amd_family.h
index 7f8a7882d1d..1165c64d853 100644
--- a/src/amd/common/amd_family.h
+++ b/src/amd/common/amd_family.h
@@ -112,6 +112,7 @@ enum radeon_family
    CHIP_NAVY_FLOUNDER,
    CHIP_VANGOGH,
    CHIP_DIMGREY_CAVEFISH,
+   CHIP_BEIGE_GOBY,
    CHIP_YELLOW_CARP,
    CHIP_LAST,
 };
diff --git a/src/amd/llvm/ac_llvm_util.c b/src/amd/llvm/ac_llvm_util.c
index 9deeb91ded6..8ba74359a8c 100644
--- a/src/amd/llvm/ac_llvm_util.c
+++ b/src/amd/llvm/ac_llvm_util.c
@@ -173,6 +173,7 @@ const char *ac_get_llvm_processor_name(enum radeon_family family)
    case CHIP_SIENNA_CICHLID:
    case CHIP_NAVY_FLOUNDER:
    case CHIP_DIMGREY_CAVEFISH:
+   case CHIP_BEIGE_GOBY:
    case CHIP_VANGOGH:
    case CHIP_YELLOW_CARP:
       return "gfx1030";
diff --git a/src/gallium/drivers/radeon/radeon_vcn_dec.c b/src/gallium/drivers/radeon/radeon_vcn_dec.c
index 438ec89b17a..3b0edcf3e37 100644
--- a/src/gallium/drivers/radeon/radeon_vcn_dec.c
+++ b/src/gallium/drivers/radeon/radeon_vcn_dec.c
@@ -2455,6 +2455,7 @@ struct pipe_video_codec *radeon_create_decoder(struct pipe_context *context,
    case CHIP_SIENNA_CICHLID:
    case CHIP_NAVY_FLOUNDER:
    case CHIP_DIMGREY_CAVEFISH:
+   case CHIP_BEIGE_GOBY:
    case CHIP_VANGOGH:
    case CHIP_YELLOW_CARP:
       dec->reg.data0 = RDECODE_VCN2_5_GPCOM_VCPU_DATA0;
diff --git a/src/gallium/drivers/radeonsi/si_get.c b/src/gallium/drivers/radeonsi/si_get.c
index c5b7edd036b..f7d4c66e3b1 100644
--- a/src/gallium/drivers/radeonsi/si_get.c
+++ b/src/gallium/drivers/radeonsi/si_get.c
@@ -552,7 +552,7 @@ static int si_get_video_param(struct pipe_screen *screen, enum pipe_video_profil
    switch (param) {
    case PIPE_VIDEO_CAP_SUPPORTED:
       if (codec < PIPE_VIDEO_FORMAT_MPEG4_AVC &&
-          sscreen->info.family >= CHIP_YELLOW_CARP)
+          sscreen->info.family >= CHIP_BEIGE_GOBY)
          return false;
       switch (codec) {
       case PIPE_VIDEO_FORMAT_MPEG12:
-- 
2.32.0

