From 85acf8a1ac4e8c53c065cd13ffaced0f942fa8a7 Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Wed, 24 Mar 2021 17:56:27 +0100
Subject: [PATCH 2/5] ac: add ac_gpu_info::has_image_load_dcc_bug

Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Reviewed-by: Bas Nieuwenhuizen <bas@basnieuwenhuizen.nl>
Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/9919>
---
 src/amd/common/ac_gpu_info.c                  | 6 ++++++
 src/amd/common/ac_gpu_info.h                  | 1 +
 src/amd/vulkan/winsys/null/radv_null_winsys.c | 3 +++
 3 files changed, 10 insertions(+)

diff --git a/src/amd/common/ac_gpu_info.c b/src/amd/common/ac_gpu_info.c
index 6ac6a51cbea..31789b53190 100644
--- a/src/amd/common/ac_gpu_info.c
+++ b/src/amd/common/ac_gpu_info.c
@@ -801,6 +801,12 @@ bool ac_query_gpu_info(int fd, void *dev_p, struct radeon_info *info,
    /* Drawing from 0-sized index buffers causes hangs on Navi10/14. */
    info->has_zero_index_buffer_bug = info->family == CHIP_NAVI10 || info->family == CHIP_NAVI14;
 
+   /* Whether chips are affected by the image load/sample/gather hw bug when
+    * DCC is enabled (ie. WRITE_COMPRESS_ENABLE should be 0).
+    */
+   info->has_image_load_dcc_bug = info->family == CHIP_DIMGREY_CAVEFISH ||
+                                  info->family == CHIP_VANGOGH;
+
    /* Support for GFX10.3 was added with F32_ME_FEATURE_VERSION_31 but the
     * firmware version wasn't bumped.
     */
diff --git a/src/amd/common/ac_gpu_info.h b/src/amd/common/ac_gpu_info.h
index d6c35c18fe8..8759b48b76f 100644
--- a/src/amd/common/ac_gpu_info.h
+++ b/src/amd/common/ac_gpu_info.h
@@ -76,6 +76,7 @@ struct radeon_info {
    bool has_msaa_sample_loc_bug;
    bool has_ls_vgpr_init_bug;
    bool has_zero_index_buffer_bug;
+   bool has_image_load_dcc_bug;
    bool has_32bit_predication;
 
    /* Display features. */
diff --git a/src/amd/vulkan/winsys/null/radv_null_winsys.c b/src/amd/vulkan/winsys/null/radv_null_winsys.c
index 6320a975da9..a530c0e06b3 100644
--- a/src/amd/vulkan/winsys/null/radv_null_winsys.c
+++ b/src/amd/vulkan/winsys/null/radv_null_winsys.c
@@ -132,6 +132,9 @@ static void radv_null_winsys_query_info(struct radeon_winsys *rws,
 
 	info->has_dedicated_vram = gpu_info[info->family].has_dedicated_vram;
 	info->has_packed_math_16bit = info->chip_class >= GFX9;
+
+	info->has_image_load_dcc_bug = info->family == CHIP_DIMGREY_CAVEFISH ||
+				       info->family == CHIP_VANGOGH;
 }
 
 static void radv_null_winsys_destroy(struct radeon_winsys *rws)
-- 
2.32.0

